# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
if(!require(ggplot2)) install.packages("ggplot2")
library(ggplot2)

# –ó–∞–¥–∞–Ω–∏–µ 1 ----

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(1)
ar_process <- function(n, theta) {
  # –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  # n - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
  # theta - –ø–∞—Ä–∞–º–µ—Ç—Ä AR(1)
  
  # –°–æ–∑–¥–∞–µ–º –≤–µ–∫—Ç–æ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(1)
  x <- numeric(n)
  
  # –ó–∞–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ
  x[1] <- rnorm(1)
  
  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å AR(1)
  for (k in 2:n) {
    x[k] <- theta * x[k-1] + rnorm(1)
  }
  
  return(x)
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
plot_ar <- function(n, theta) {
  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å AR(1)
  ar_series <- ar_process(n, theta)
  
  # –°–æ–∑–¥–∞–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
  df <- data.frame(Time = 1:n, Value = ar_series)
  
  # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
  ggplot(df, aes(x = Time, y = Value)) +
    geom_line(color = "blue") +
    ggtitle(paste("AR(1) Process with theta =", theta)) +
    xlab("Time") +
    ylab("Value") +
    theme_minimal()
}

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
n <- 100  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π

# a) |ùúÉ| < 1
plot_ar(n, 0.5)

# b) |ùúÉ| = 1
plot_ar(n, 1)

# c) |ùúÉ| > 1
plot_ar(n, 1.5)

# –ó–∞–¥–∞–Ω–∏–µ 2 ----

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ theta –ø–æ –ú–ù–ö
estimate_theta <- function(x) {
  # –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  # x - –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(1)
  
  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
  n <- length(x)
  
  # –ß–∏—Å–ª–∏—Ç–µ–ª—å –∏ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ theta
  numerator <- sum(x[2:n] * x[1:(n-1)])
  denominator <- sum(x[1:(n-1)]^2)
  
  # –û—Ü–µ–Ω–∫–∞ theta
  theta_hat <- numerator / denominator
  
  return(theta_hat)
}

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å AR(1) —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º theta
n <- 100
true_theta <- 0.7
x <- ar_process(n, true_theta)

# –û—Ü–µ–Ω–∫–∞ theta –ø–æ –ú–ù–ö
estimated_theta <- estimate_theta(x)
cat("–û—Ü–µ–Ω–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ theta:", estimated_theta, "\n")

# –ü–æ—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –æ—Ü–µ–Ω–∫–æ–π theta
plot_ar(n, estimated_theta)

# –ó–∞–¥–∞–Ω–∏–µ 3 ----

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ theta –º–µ—Ç–æ–¥–æ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è (–ú–ü)
estimate_theta_mle <- function(x) {
  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
  n <- length(x)
  
  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è)
  log_likelihood <- function(theta) {
    sum((x[2:n] - theta * x[1:(n-1)])^2)
  }
  
  # –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–∞ Brent
  mle_result <- optimize(log_likelihood, interval = c(-2, 2))$minimum
  
  return(mle_result)
}

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å AR(1) —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º theta
n <- 100
true_theta <- 0.7
x <- ar_process(n, true_theta)

# –û—Ü–µ–Ω–∫–∞ theta –ø–æ –º–µ—Ç–æ–¥—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è (–ú–ü)
estimated_theta_mle <- estimate_theta_mle(x)
cat("–û—Ü–µ–Ω–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ theta –ø–æ –ú–ü:", estimated_theta_mle, "\n")

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ—Ü–µ–Ω–∫–æ–π –ú–ù–ö
estimated_theta_mnk <- estimate_theta(x)
cat("–û—Ü–µ–Ω–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ theta –ø–æ –ú–ù–ö:", estimated_theta_mnk, "\n")
# –î–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(1) —Å –≥–∞—É—Å—Å–æ–≤—Å–∫–∏–º —à—É–º–æ–º, 
# –∫–∞–∫ –ú–ù–ö, —Ç–∞–∫ –∏ –ú–ü-–æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ùúÉ –¥–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, 
# –ø–æ—Å–∫–æ–ª—å–∫—É –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å—É–º–º—ã –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –æ—à–∏–±–æ–∫ –≤ –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–∞—Ö –ø—Ä–∏–≤–æ–¥–∏—Ç 
# –∫ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ —Ä–µ—à–µ–Ω–∏—é. –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, 
# —á—Ç–æ –¥–ª—è –≥–∞—É—Å—Å–æ–≤—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è 
# –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è —Å–≤–æ–¥–∏—Ç—Å—è –∫ –∑–∞–¥–∞—á–µ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–æ–π –∂–µ 
# —Å—É–º–º—ã –∫–≤–∞–¥—Ä–∞—Ç–æ–≤, —á—Ç–æ –∏ –≤ –ú–ù–ö

# –í—ã–≤–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ü–µ–Ω–æ–∫
plot_ar(n, true_theta)
plot_ar(n, estimated_theta_mle)

# –ó–∞–¥–∞–Ω–∏–µ 4 ----

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ú–ù–ö-–æ—Ü–µ–Ω–∫–∏ –Ω–∞ –≤—ã–±–æ—Ä–∫–µ –æ—Ç k –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
calculate_mnk_over_k <- function(x, k_min = 10) {
  # –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  # x - –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(1)
  # k_min - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
  
  n <- length(x)  # –û–±—ä–µ–º –≤—Å–µ–π –≤—ã–±–æ—Ä–∫–∏
  theta_estimates <- numeric(n - k_min + 1)  # –í–µ–∫—Ç–æ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ü–µ–Ω–æ–∫ –ú–ù–ö
  
  # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ú–ù–ö-–æ—Ü–µ–Ω–∫—É –¥–ª—è –≤—ã–±–æ—Ä–æ–∫ —Ä–∞–∑–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –æ—Ç k_min –¥–æ n
  for (k in k_min:n) {
    theta_estimates[k - k_min + 1] <- estimate_theta(x[1:k])
  }
  
  return(theta_estimates)
}

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∏ –ú–ù–ö-–æ—Ü–µ–Ω–æ–∫
plot_mnk_dynamics <- function(theta_estimates, k_min = 10) {
  # –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
  # theta_estimates - –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ú–ù–ö-–æ—Ü–µ–Ω–æ–∫
  # k_min - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏
  
  # –°–æ–∑–¥–∞–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
  k_values <- seq(k_min, length(theta_estimates) + k_min - 1)
  df <- data.frame(k = k_values, Theta_Estimate = theta_estimates)
  
  # –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
  ggplot(df, aes(x = k, y = Theta_Estimate)) +
    geom_line(color = "blue") +
    geom_hline(yintercept = true_theta, linetype = "dashed", color = "red") +
    ggtitle("–î–∏–Ω–∞–º–∏–∫–∞ –ú–ù–ö-–æ—Ü–µ–Ω–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ theta") +
    xlab("–û–±—ä–µ–º –≤—ã–±–æ—Ä–∫–∏ (k)") +
    ylab("–ú–ù–ö-–æ—Ü–µ–Ω–∫–∞ theta") +
    theme_minimal()
}

# (a) –ó–∞–º–æ–¥–µ–ª–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å AR(1) –¥–ª—è –æ–±—ä–µ–º–∞ –≤—ã–±–æ—Ä–∫–∏ n = 1000
n <- 1000
true_theta <- 0.7
x <- ar_process(n, true_theta)

# (b)-(c) –†–∞—Å—Å—á–∏—Ç–∞–µ–º –ú–ù–ö-–æ—Ü–µ–Ω–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–æ–∫ –æ—Ç k = 10 –¥–æ n
mnk_estimates <- calculate_mnk_over_k(x, k_min = 10)

# (d) –ü–æ—Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ú–ù–ö-–æ—Ü–µ–Ω–æ–∫
plot_mnk_dynamics(mnk_estimates, k_min = 10)

# –ó–∞–¥–∞–Ω–∏–µ 5 ----

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(2)
check_stationarity <- function(theta1, theta2) {
  # –†–µ—à–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–ª—è –∫–æ—Ä–Ω–µ–π
  discriminant <- theta1^2 - 4 * theta2
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞–Ω—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º
  if (discriminant < 0) {
    # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –∫–æ—Ä–Ω–∏
    lambda_real <- theta1 / 2
    lambda_imaginary <- sqrt(abs(discriminant)) / 2
    
    # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ—Ä–Ω–µ–π
    modulus <- sqrt(lambda_real^2 + lambda_imaginary^2)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ |lambda| < 1 –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π
    is_stationary <- modulus < 1
  } else {
    # –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ—Ä–Ω–∏
    lambda1 <- (theta1 + sqrt(discriminant)) / 2
    lambda2 <- (theta1 - sqrt(discriminant)) / 2
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏–µ |lambda_i| < 1 –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ—Ä–Ω–µ–π
    is_stationary <- abs(lambda1) < 1 && abs(lambda2) < 1
  }
  
  return(is_stationary)
}

# –ü—Ä–∏–º–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è AR(2)
theta1 <- 0.5
theta2 <- -0.2  # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ—Å—Ç—å
if (check_stationarity(theta1, theta2)) {
  cat("–ü—Ä–æ—Ü–µ—Å—Å AR(2) —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω.\n")
  
  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å AR(2) –∏ —Å—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫
  n <- 1000
  plot_ar2(n, theta1, theta2)
} else {
  cat("–ü—Ä–æ—Ü–µ—Å—Å AR(2) –Ω–µ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.\n")
}

## –ó–∞–¥–∞–Ω–∏–µ 6 ----

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–∞ 'stats' (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
# install.packages("stats")

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ 'stats'
library(stats)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(2) –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∑–∞–¥–∞–Ω–∏–∏
theta1 <- 0.5
theta2 <- -0.2
n <- 1000
x <- ar2_process(n, theta1, theta2)  # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ AR(2) –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ arima –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ AR(2)
arima_model <- arima(x, order = c(2, 0, 0), include.mean = FALSE)

# –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
print(arima_model)
